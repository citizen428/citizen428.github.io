
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title> XML diffs with bash and awk - citizen428.blog()</title>
  <meta name="author" content="Michael Kohl">

  
  <meta name="description" content="Slightly modified version of a post I originally wrote for our company blog.
When importing data at work, we often have to deal with XML. This &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://citizen428.net/blog/2010/10/01/xml-diffs-with-bash-and-awk/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="citizen428.blog()" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<meta name="google-site-verification" content="bArHZu2u3n3GxMD_LR02GfyzeA-nYFOuaBuDbfJT07U" />
<meta name="verify-postrank" content="q9zqqyw" />
<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://citizen428.myopenid.com/" />

<script type="text/javascript">
/* <![CDATA[ */
    (function() {
        var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';
        t.parentNode.insertBefore(s, t);
    })();
/* ]]> */
</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1416057-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">citizen428.blog()</a></h1>
  
    <h2>Try to learn something about everything</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:citizen428.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about/">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/talks_and_publications">Talks and Publications</a></li>
  <li><a href="/studynotes">Study Notes</a></li>
  <li><a href="/imprint/">Imprint</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">XML Diffs With Bash and Awk</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-01T00:00:00+02:00" pubdate data-updated="true">Oct 1<span>st</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><i>Slightly modified version of a <a href="http://tupalo.com/en/blog/generating-xml-diffs-with-awk-and-bash/">post</a> I originally wrote for our <a href="http://tupalo.com/en/blog/">company blog</a>.</i></p>
<p>When importing data at work, we often have to deal with <span class="caps">XML</span>. This generally works fine, but the format&#8217;s structured nature also means that you can&#8217;t just treat it like any old text file.</p>
<p>That&#8217;s something we recently had to work around when we wanted to generate a daily <span class="caps">XML</span> diff, which only contains elements which changed since the previous feed. Of course there are several open source tools for diff-ing <span class="caps">XML</span> (e.g. <a href="http://diffxml.sourceforge.net/">diffxml</a> or <a href="http://www.logilab.org/859">xmldiff</a>) but since we didn&#8217;t get them to do what we want in a reasonable amount of time, we just decided to roll our own.</p>
<p>The final solution is a 71 line bash script, which downloads a zip, extracts it, generates <a href="http://en.wikipedia.org/wiki/MD5">MD5</a> sums for every element and then creates a diff between this new file and the previous list of MD5 sums. Once we know which elements have changed we merge them into a new feed which then gets handed to our importer. The awesome <a href="http://xmlstar.sourceforge.net/">xmlstarlet</a> was a great help in this, as was battle-tested old <a href="http://en.wikipedia.org/wiki/AWK">awk</a>.</p>
<p>Let&#8217;s look at an interesting snippet from the script:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>xmlstarlet sel -I -t -m <span class="s2">&quot;//item&quot;</span> -v <span class="s2">&quot;./guid&quot;</span> -o <span class="s2">&quot;|&quot;</span> -c <span class="s2">&quot;.&quot;</span> -n - |
</span><span class='line'>  sed -e <span class="s1">&#39;...&#39;</span> |
</span><span class='line'>  awk <span class="se">\</span>
</span><span class='line'>    <span class="s1">&#39;BEGIN {</span>
</span><span class='line'><span class="s1">      FS=&quot;|&quot;</span>
</span><span class='line'><span class="s1">      RS=&quot;\n&quot;</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">    {</span>
</span><span class='line'><span class="s1">      id=$1</span>
</span><span class='line'><span class="s1">      command=&quot;printf \&quot;%s\&quot; \&quot;&quot; $2 &quot;\&quot; | md5sum | cut -d\&quot; \&quot; -f1&quot;</span>
</span><span class='line'><span class="s1">      command | getline md5</span>
</span><span class='line'><span class="s1">      close(command)</span>
</span><span class='line'><span class="s1">      print id&quot;:&quot;md5</span>
</span><span class='line'><span class="s1">    }&#39;</span> &gt;&gt; <span class="nv">$MD5_DIR</span>/vendor-md5-<span class="nv">$TODAY</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>Here we use xmlstarlet to iterate over all the items in the feed (the <a href="http://www.w3.org/TR/xpath/">XPath</a> &#8220;//item&#8221;), print the value of the &#8220;guid&#8221; element (-v &#8220;./guid&#8221;), output a pipe character (-o &#8220;|&#8221;) and then copy the current element followed by a newline (-c &#8220;.&#8221; -n) . This then gets piped through sed for some cleaning up (which I omitted here for brevity&#8217;s sake) before awk takes the part after each &#8220;|&#8221;, generates an MD5 sum and finally produces a file that looks like this:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rKKTZ:4012fced7c4cd77da607d294fbb8b5b6
</span><span class='line'>hC7Jr:39245a0f9a976e6d47c0e2d76abf6238
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>Now that we are able to create a daily list of MD5 sums, it&#8217;s easy to generate the diff feed:</p>
<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">if</span> <span class="o">[</span> -e <span class="nv">$MD5_DIR</span>/vendor-md5-last <span class="o">]</span> ; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">changed</span><span class="o">=</span><span class="sb">`</span>diff <span class="nv">$MD5_DIR</span>/vendor-md5-last <span class="nv">$MD5_DIR</span>/vendor-md5-<span class="nv">$TODAY</span> |
</span><span class='line'>	   grep <span class="s2">&quot;^&gt;&quot;</span> |
</span><span class='line'>           cut -d<span class="s2">&quot;:&quot;</span> -f 1 |
</span><span class='line'>           cut -b 1-2 --complement<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>record in <span class="nv">$changed</span> ; <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="nv">f</span><span class="o">=</span><span class="sb">`</span>fgrep -l <span class="s2">&quot;&lt;guid&gt;$record&lt;/guid&gt;&quot;</span> <span class="nv">$FILE_PATTERN</span><span class="sb">`</span>
</span><span class='line'>  xmlstarlet sel -I -t -c <span class="s2">&quot;/rss/channel/item[guid=&#39;$record&#39;]&quot;</span> <span class="nv">$f</span> &gt;&gt; vendor-import-<span class="nv">$TODAY</span>.xml
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure></div></notextile></p>
<p>Here we create an array with the id of the changed elements over which we then iterate. In the loop we once again use xmlstarlet to extract the current item from the feed which contains the right guid.</p>
<p>I&#8217;m quite happy with the result, it does exactly what we want it to do and is also reasonably fast. This is a good example of how familiar Unix tools can be combined to create fairly concise solutions for non-trivial problem.</p></div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Michael Kohl</span></span>

      








  


<time datetime="2010-10-01T00:00:00+02:00" pubdate data-updated="true">Oct 1<span>st</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/programming/'>programming</a>, <a class='category' href='/blog/categories/shell/'>shell</a>
  
</span>


    </p>
    
      <div class="sharing">
  
    <a class="FlattrButton" style="display:none;"
    title=" XML diffs with bash and awk"
    data-flattr-uid="citizen428"
    data-flattr-tags=""
    data-flattr-button="compact"
    data-flattr-category="text"
    href="http://citizen428.net/blog/2010/10/01/xml-diffs-with-bash-and-awk/">
    
</a>

  
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://citizen428.net/blog/2010/10/01/xml-diffs-with-bash-and-awk/" data-via="citizen428" data-counturl="http://citizen428.net/blog/2010/10/01/xml-diffs-with-bash-and-awk/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/09/26/information-overload-2010-09-26/" title="Previous Post: Information Overload 2010-09-26">&laquo; Information Overload 2010-09-26</a>
      
      
        <a class="basic-alignment right" href="/blog/2010/10/03/information-overload-2010-10-02/" title="Next Post: Information Overload 2010-10-02">Information Overload 2010-10-02 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About citizen428</h1>
  <p>I'm Michael Kohl, generally known as citizen428 online. I mainly
  write about programming, and do a regular <a href="/blog/categories/informationoverload/">blog post series</a> collecting interesting
  articles I enjoyed throughout the week.</p>
<div id="social_media_icons" align="center">
<a href="http://twitter.com/citizen428"><img src="/images/icons/twitter.png"
                                             alt="Twitter" /></a>
<a href="https://plus.google.com/u/0/101046237539584353961/posts"><img src="/images/icons/google.png"
                                             alt="Twitter"
                                             /></a>
<a href="http://www.linkedin.com/in/citizen428"><img src="/images/icons/linkedin.png"
                                             alt="Twitter" /></a>
</div>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("citizen428", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/citizen428" class="twitter-follow-button" data-show-count="true">Follow @citizen428</a>
  
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/citizen428">@citizen428</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'citizen428',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Michael Kohl -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'citizen428-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://citizen428.net/blog/2010/10/01/xml-diffs-with-bash-and-awk/';
        var disqus_url = 'http://citizen428.net/blog/2010/10/01/xml-diffs-with-bash-and-awk/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
