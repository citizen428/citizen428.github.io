<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: lua | citizen428.blog()]]></title>
  <link href="http://citizen428.net/blog/categories/lua/atom.xml" rel="self"/>
  <link href="http://citizen428.net/"/>
  <updated>2013-09-01T23:23:22+08:00</updated>
  <id>http://citizen428.net/</id>
  <author>
    <name><![CDATA[Michael Kohl]]></name>
    <email><![CDATA[citizen428@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Writing nmap scripts with Lua]]></title>
    <link href="http://citizen428.net/blog/2011/12/23/writing-nmap-scripts-with-lua/"/>
    <updated>2011-12-23T13:54:00+08:00</updated>
    <id>http://citizen428.net/blog/2011/12/23/writing-nmap-scripts-with-lua</id>
    <content type="html"><![CDATA[<p>About 2 weeks ago I finally started looking into <a href="http://www.lua.org/">Lua</a>, a language that&rsquo;s been on my radar for a while but that I never really got around to play with so far. Then I realized that the <a href="http://nmap.org/book/nse.html">Nmap Scripting Engine</a> uses Lua scripts, so I had an excuse to hack on this stuff for work. Here&rsquo;s my first small <code>nmap</code> script, which will extract the contents of the generator meta tag if there is one. It&rsquo;s nothing funky, but it shows how easy it is to write custom scripts for <code>nmap</code> thanks to the provided libraries like <code>http</code> and <code>shortport</code>.</p>

<p>{% codeblock lang:lua %}
description = [[
Displays the contents of the &ldquo;generator&rdquo; meta tag if there is one.
]]</p>

<p>author = &ldquo;Michael Kohl&rdquo;
license = &ldquo;Same as Nmap&mdash;See <a href="http://nmap.org/book/man-legal.html">http://nmap.org/book/man-legal.html</a>&rdquo;
categories = {&ldquo;discovery&rdquo;, &ldquo;safe&rdquo;}</p>

<p>&mdash; documentation skipped</p>

<p>require(&lsquo;http&rsquo;)
require(&lsquo;shortport&rsquo;)</p>

<p>portrule = shortport.http</p>

<p>action = function(host, port)
   local response, loc, generator</p>

<p>   response = http.get(host, port, &lsquo;/&rsquo;)</p>

<p>   &mdash; deal with redirects
   while response[&lsquo;status-line&rsquo;]:lower():match(&ldquo;^http/1.1 30[12]&rdquo;) do</p>

<pre><code>  loc = response.header['location']
  response = http.get_url(loc)
</code></pre>

<p>   end</p>

<p>   for line in response.body:gmatch(&ldquo;[^\r\n]+&rdquo;) do</p>

<pre><code>  generator = line:match('&lt;meta name="generator" content="(.*)" /&gt;')
  if generator then
     return generator
  end
</code></pre>

<p>   end
end
{% endcodeblock %}</p>

<p><strong>Update:</strong> Here&rsquo;s the version that&rsquo;s now part of <code>nmap</code>, it even made it to the default category.</p>

<p>{% codeblock lang:lua %}
description = [[
Displays the contents of the &ldquo;generator&rdquo; meta tag if there is one.
]]</p>

<p>author = &ldquo;Michael Kohl&rdquo;
license = &ldquo;Same as Nmap&mdash;See <a href="http://nmap.org/book/man-legal.html">http://nmap.org/book/man-legal.html</a>&rdquo;
categories = {&ldquo;default&rdquo;, &ldquo;discovery&rdquo;, &ldquo;safe&rdquo;}</p>

<p>&mdash; documentation skipped</p>

<p>require(&lsquo;http&rsquo;)
require(&lsquo;shortport&rsquo;)
require(&lsquo;stdnse&rsquo;)</p>

<p>&mdash; helper function
local follow_redirects = function(host, port, path, n)
   local pattern = &ldquo;^[hH][tT][tT][pP]/1.[01] 30[12]&rdquo;
   local response = http.get(host, port, path)</p>

<p>   while response[&lsquo;status-line&rsquo;]:match(pattern) and n > 0 do</p>

<pre><code>  n = n - 1
  loc = response.header['location']
  response = http.get_url(loc)
</code></pre>

<p>   end</p>

<p>   return response
end</p>

<p>portrule = shortport.http</p>

<p>action = function(host, port)
   local response, loc, generator
   local path = stdnse.get_script_args(&lsquo;http-generator.path&rsquo;) or &lsquo;/&rsquo;
   local redirects = tonumber(stdnse.get_script_args(&lsquo;http-generator.redirects&rsquo;)) or 3</p>

<p>   &mdash; Worst case: <meta name=Generator content="Microsoft Word 11">
   local pattern = &lsquo;<meta name="?generator"? content="([^\"]*)" ?/?>&rsquo;</p>

<p>   &mdash; make pattern case-insensitive
   pattern = pattern:gsub(&ldquo;%a&rdquo;, function &copy;</p>

<pre><code>           return string.format("[%s%s]", string.lower(c),
                                          string.upper(c))
         end)
</code></pre>

<p>   response = follow_redirects(host, port, path, redirects)
   return response.body:match(pattern)</p>

<p>end
{% endcodeblock %}</p>
]]></content>
  </entry>
  
</feed>
